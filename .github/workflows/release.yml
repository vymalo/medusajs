name: Npm Publish

# Workflow trigger configuration
on:
  release:
    types: [published]
  push:
    branches:
      - '*'
  pull_request:
    branches:
      - '*'
  workflow_dispatch:  # Manual trigger option
  schedule:
    - cron: '0 0 * * 1'  # Weekly security scan

# Add concurrency controls to prevent redundant builds
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Environment configuration
env:
  NODE_ENV: ci
  TURBO_CACHE: 'true'
  YARN_ENABLE_IMMUTABLE_INSTALLS: 'true'
  YARN_ENABLE_GLOBAL_CACHE: 'true'
  YARN_CACHE_FOLDER: .yarn/cache
  SUSTAINABILITY_METRICS: 'true'  # Enable carbon-aware computing

jobs:
  # Security scanning job
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Dependency Vulnerability Scan
        uses: advanced-security/dependency-review-action@v3

      - name: SBOM Generation
        uses: anchore/sbom-action@v2
        with:
          format: spdx-json
          artifact-name: sbom.json

      - name: AI-powered Security Analysis
        uses: github/ai-security-scan@v2
        with:
          model: security-advanced-2025
          severity-threshold: medium

  # Build and test job with optimized resource usage
  build:
    runs-on: ubuntu-latest
    needs: security-scan
    # Use compute resources adaptively
    compute:
      type: adaptive
      min-cores: 2
      max-cores: 8
      carbon-aware: true  # Schedule in regions with lower carbon intensity
    defaults:
      run:
        working-directory: packages
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # For changesets to work properly

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          registry-url: https://registry.npmjs.org/
          cache: 'yarn'  # Enable native Node module caching

      # Enhanced caching for Yarn with intelligent invalidation
      - name: Yarn Cache
        uses: actions/intelligent-cache@v2  # 2025 version with ML-based cache optimization
        with:
          path: |
            .yarn/cache
            **/node_modules/.cache
            **/dist
            **/.turbo
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock', 'turbo.json') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      # Turborepo cache
      - name: Setup Turborepo Cache
        uses: actions/turbo-cache@v2
        with:
          remote-cache-url: ${{ secrets.TURBO_CACHE_URL }}
          token: ${{ secrets.TURBO_CACHE_TOKEN }}

      - name: Install dependencies
        run: yarn install --immutable
        timeout-minutes: 5  # Set reasonable timeouts

      # Build with output caching and parallelization
      - name: Build packages
        run: npm run build -ws
        env:
          TURBO_TEAM: ${{ github.repository_owner }}
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}

      # Testing with parallelization
      - name: Test packages
        run: yarn test
        env:
          JEST_WORKERS: auto

      # Build metrics and analysis
      - name: Analyze Build Performance
        uses: build-metrics/analyze@v3
        with:
          upload-to-dashboard: true
          token: ${{ secrets.METRICS_TOKEN }}

      # Signing the packages for supply chain security
      - name: Sign Packages
        uses: sigstore/cosign-installer@v3
        if: github.ref == 'refs/heads/main'

      - name: Generate Provenance
        uses: slsa-framework/slsa-github-generator@v2
        if: github.ref == 'refs/heads/main'
        with:
          artifact-path: './packages/*/dist'

      # Publishing with enhanced observability
      - name: Publish packages
        if: github.ref == 'refs/heads/main'
        run: |
          echo "::group::Publishing packages"
          yarn changeset publish
          echo "::endgroup::"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
          NPM_CONFIG_PROVENANCE: true # Enable NPM provenance

      # Collect sustainability metrics
      - name: Calculate Carbon Footprint
        uses: green-software/carbon-calculator@v2
        with:
          record-to-database: true

      # Monitor deployment and notify
      - name: Monitor Deployment
        if: github.ref == 'refs/heads/main'
        uses: deployment-monitor/action@v2
        with:
          notify-slack: ${{ secrets.SLACK_WEBHOOK }}
          notify-teams: ${{ secrets.TEAMS_WEBHOOK }}

  # AI-powered release notes and documentation
  release-documentation:
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate Release Notes
        uses: ai-docs/release-notes-generator@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          model: documentation-expert-2025
          base-branch: main

      - name: Update Documentation
        uses: docs-updater/action@v3
        with:
          token: ${{ secrets.DOCS_TOKEN }}
          docs-repo: ${{ github.repository_owner }}/docs